<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weather Forecast</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background-color: #f4f4f9;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
        }
        h1 {
            text-align: center;
        }
        .weather-info, .forecast {
            margin-bottom: 20px;
        }
        .forecast-day {
            margin: 20px 0;
            padding: 15px;
            border-radius: 8px;
            background-color: #f9f9f9;
            box-shadow: 0px 0px 5px rgba(0, 0, 0, 0.1);
        }
        .forecast-day strong {
            font-size: 1.5em;
        }
        .forecast-day .main-info {
            font-size: 1.2em;
            font-weight: bold;
        }
        .forecast-day .description {
            font-size: 1em;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Weather Forecast</h1>
        <div class="weather-info">
            <h2>Current Weather</h2>
            <p id="current-temp">Loading temperature...</p>
            <p id="current-humidity">Loading humidity...</p>
            <p id="current-description">Loading description...</p>
        </div>
        <div class="forecast">
            <h2>5-Day Forecast</h2>
            <div id="forecast-days">
                <p>Loading forecast...</p>
            </div>
        </div>
    </div>

    <script>
        // Function to extract low temperature from detailed forecast
        function extractLowTemperature(detailedForecast) {
            const lowTempMatch = detailedForecast.match(/low around (\d+)/i);
            return lowTempMatch ? Number(lowTempMatch[1]) : null;
        }

        function formatTemperature(value, unit, fallback) {
            if (value === null || value === undefined || value === '') {
                return fallback;
            }
            const numericValue = typeof value === 'string' ? Number(value) : value;
            if (Number.isNaN(numericValue)) {
                return fallback;
            }
            return `${Math.round(numericValue)}째${unit}`;
        }

        function formatCurrentTemperature(value, unitCode) {
            if (value === null || value === undefined || value === '') {
                return "Temperature: N/A";
            }
            if (unitCode && unitCode.includes("degC")) {
                const fahrenheit = (value * 9) / 5 + 32;
                return `Temperature: ${Math.round(fahrenheit)}째F`;
            }
            if (unitCode && unitCode.includes("degF")) {
                return `Temperature: ${Math.round(value)}째F`;
            }
            return `Temperature: ${Math.round(value)}째F`;
        }

        async function fetchWeatherData() {
            try {
                const response = await fetch('https://api.weather.gov/points/42.5136,-90.6012');
                const data = await response.json();
                const { forecast, observationStations } = data.properties;

                // Fetch current weather data
                const stationResponse = await fetch(observationStations);
                const stationData = await stationResponse.json();
                const stationId = stationData.features[0].properties.stationIdentifier;
                const observationResponse = await fetch(`https://api.weather.gov/stations/${stationId}/observations/latest`);
                const observationData = await observationResponse.json();
                const currentTemp = observationData.properties.temperature.value;
                const currentTempUnitCode = observationData.properties.temperature.unitCode;
                const currentHumidity = observationData.properties.relativeHumidity.value;
                const currentDescription = observationData.properties.textDescription;

                // Fetch 5-day forecast
                const forecastResponse = await fetch(forecast);
                const forecastData = await forecastResponse.json();
                const forecastPeriods = forecastData.properties.periods.slice(0, 5);

                // Update current weather
                document.getElementById('current-temp').textContent = formatCurrentTemperature(currentTemp, currentTempUnitCode);
                document.getElementById('current-humidity').textContent = `Humidity: ${currentHumidity}%`;
                document.getElementById('current-description').textContent = `Description: ${currentDescription}`;

                // Update forecast
                const forecastContainer = document.getElementById("forecast-days");
                forecastContainer.innerHTML = ''; // Clear loading text

                forecastPeriods.forEach(day => {
                    const forecastElement = document.createElement("div");
                    forecastElement.classList.add("forecast-day");

                    const temperatureUnit = day.temperatureUnit || "F";
                    const highTemperature = day.temperature;

                    // Extract low temperature from detailed forecast
                    let lowTemperature = day.temperatureLow;
                    if ((lowTemperature === null || lowTemperature === undefined) && day.detailedForecast) {
                        lowTemperature = extractLowTemperature(day.detailedForecast);
                    }

                    const shortForecast = day.shortForecast || "No forecast available";
                    const detailedForecast = day.detailedForecast || "No detailed description available";

                    // Construct the forecast display without innerHTML
                    const mainInfo = document.createElement("div");
                    mainInfo.classList.add("main-info");

                    const dayName = document.createElement("strong");
                    dayName.textContent = day.name;
                    mainInfo.appendChild(dayName);
                    mainInfo.appendChild(document.createElement("br"));

                    const highLabel = formatTemperature(highTemperature, temperatureUnit, "No high temperature available");
                    const lowLabel = formatTemperature(lowTemperature, temperatureUnit, "No low temperature available");
                    const temps = document.createTextNode(`High: ${highLabel} | Low: ${lowLabel}`);
                    mainInfo.appendChild(temps);
                    mainInfo.appendChild(document.createElement("br"));

                    const forecastText = document.createTextNode(`Weather: ${shortForecast}`);
                    mainInfo.appendChild(forecastText);

                    // Construct the detailed description without innerHTML
                    const description = document.createElement("div");
                    description.classList.add("description");
                    description.textContent = detailedForecast;

                    forecastElement.appendChild(mainInfo);
                    forecastElement.appendChild(description);
                    forecastContainer.appendChild(forecastElement);
                });

            } catch (error) {
                console.error('Error fetching weather data:', error);
                document.getElementById("forecast-days").textContent = "Failed to load forecast data.";
            }
        }

        fetchWeatherData();
    </script>
</body>
</html>
